---
title: "Analysis"
output: html_document
---

```{r}
#| label: load-packages

library(tidyverse)
library(lubridate)
library(ggrepel)
```

```{r}
#| label: data-processing

load("emsData.RData")

ems <- x |>
  select(-c( # remove unneeded columns
    eTT.Pe.So, eTT.Pe.Ce, eTT.Pe.NN, eTT.Pe.FN,
    eTT.BG.So, eTT.BG.Ce, eTT.BG.NN, eTT.BG.FN,
    eTT.Op.So, eTT.Op.Ce, eTT.Op.NN, eTT.Op.FN
  )) |>
  mutate(
    BASE.NAME = recode(BASE.NAME,
                       "Company 9" = "Central",
                       "Company 1" = "South"),
    BASE.NAME = factor(BASE.NAME, levels = c("Central","South")),
    REF.GRID = case_when(
      str_detect(REF.GRID, "North")   ~ "North",
      str_detect(REF.GRID, "Central") ~ "Central",
      str_detect(REF.GRID, "South")   ~ "South",
      TRUE ~ REF.GRID
    ),
    REF.GRID = factor(REF.GRID, levels = c("South","Central","North")),
    DISPATCH.PRIORITY.NAME = recode(DISPATCH.PRIORITY.NAME,
                                    "Non Emergency" = "Non-emergency",
                                    "Emergency" = "Emergency"),
    DISPATCH.PRIORITY.NAME = factor(DISPATCH.PRIORITY.NAME,
                                    levels = c("Emergency","Non-emergency")),
    went_hospital = REC.NAME != ""
  ) |>
  mutate(
    disp_to_enroute_min = as.numeric(timeToEnroute, units = "mins"),
    response_time_min = as.numeric(observedTT,    units = "mins"),
    on_scene_min = as.numeric(onSceneDur,    units = "mins"),
    to_hospital_min = as.numeric(toHospitalTT,  units = "mins"),
    at_hospital_min = as.numeric(atHospitalDur, units = "mins"),
    total_call_min = as.numeric(dispToClearTime, units = "mins")
  )
```

```{r}
#| label: summary-stats

summaries <- list(
  response_by_region = ems |>
    group_by(REF.GRID) |>
    summarise(n = n(),
              median_resp = median(response_time_min, na.rm = TRUE),
              p90_resp    = quantile(response_time_min, 0.9, na.rm = TRUE)),
  north_near_far_share = north_choice,
  nearest_base_unavail = unavail_by_region,
  went_hospital_share  = hosp_share
)
summaries
```

# Call concentration & ambulance utilization

```{r, fig.width=12, fig.height=6}

ems_plot <- data.frame(
  lon = as.numeric(x$REF.GPS.LON),
  lat = as.numeric(x$REF.GPS.LAT)
) |> na.omit() |>
  subset(lon > -78.55 & lon < -78.25 & lat > 36.15 & lat < 36.55)

stations <- data.frame(
  name = c("South","Central"),
  lat  = c(36.2765, 36.3450),
  lon  = c(-78.4004, -78.3905)
)

stations <- data.frame(
  name = c("South","Central"),
  lat  = c(36.2765, 36.3450),
  lon  = c(-78.4004, -78.3905)
)

ggplot(ems_plot, aes(lon, lat)) +
  # hex bins look nicer than squares
  geom_hex(bins = 35, alpha = 0.95) +
  coord_fixed() +
  scale_fill_viridis_c(trans = "sqrt", name = "Calls") +
  # stations: clearer markers + labels
  geom_point(data = stations, aes(lon, lat),
             inherit.aes = FALSE, shape = 21, size = 3.8,
             stroke = 1, colour = "black", fill = "white") +
  geom_label_repel(data = stations, aes(lon, lat, label = name),
                   inherit.aes = FALSE, size = 3,
                   label.padding = unit(0.12, "lines"),
                   label.size = 0, seed = 1) +
  labs(title = "EMS call density",
       subtitle = "Outlier removed",
       x = "Longitude", y = "Latitude") +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(face = "bold", size = 16),
    legend.key.height = unit(0.6, "cm")
  )
```

```{r}
ems <- ems %>%
  mutate(
    DT.DISP      = as_datetime(DT.DISP),
    DT.AVAILABLE = as_datetime(DT.AVAILABLE)
  ) %>%
  filter(!is.na(VEH.GRID), !is.na(DT.DISP), !is.na(DT.AVAILABLE),
         DT.AVAILABLE >= DT.DISP)

# Observation window (used for utilization denominators)
t_start <- min(ems$DT.DISP, na.rm = TRUE)
t_end   <- max(ems$DT.AVAILABLE, na.rm = TRUE)
obs_seconds <- as.numeric(t_end - t_start, units = "secs")

# ---- 1) Build a global event timeline (+1 at dispatch, -1 at available) ----
events <- ems %>%
  transmute(VEH.GRID, start = DT.DISP, end = DT.AVAILABLE) %>%
  pivot_longer(c(start, end), names_to = "etype", values_to = "time") %>%
  mutate(delta = if_else(etype == "start", 1L, -1L))

# Important tie-break: if a unit becomes available at the same instant another dispatch occurs,
# process the -1 (end) BEFORE the +1 (start) so we don't briefly overcount.
events <- events %>% arrange(time, desc(delta))  # -1 before +1 at identical timestamps

timeline <- events %>%
  transmute(time, delta) %>%
  arrange(time) %>%
  mutate(active = cumsum(delta)) %>%
  mutate(time_next = lead(time),
         seg_sec   = as.numeric(time_next - time, units = "secs")) %>%
  filter(!is.na(time_next), seg_sec > 0)

simul_summary <- timeline %>%
  group_by(active) %>%
  summarise(total_sec = sum(seg_sec), .groups = "drop") %>%
  mutate(pct_of_time = total_sec / sum(total_sec))

simul_summary
# > table with rows: active=0,1,2,3,4 (how often the system had that many units busy)
# pct_of_time is the fraction of the entire observed time.

ggplot(simul_summary, aes(factor(active), pct_of_time)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "Simultaneous busy ambulances", y = "% of observed time",
       title = "System load: how many ambulances are busy simultaneously")

# ---- 3) Percent of time fully saturated (all 4 busy) & other thresholds ----
pct_all_busy   <- simul_summary %>% filter(active >= 4) %>% summarise(p = sum(pct_of_time)) %>% pull(p)
pct_three_plus <- simul_summary %>% filter(active >= 3) %>% summarise(p = sum(pct_of_time)) %>% pull(p)

pct_all_busy
pct_three_plus
# Interpret: if pct_all_busy is tiny, saturation is rare; if sizeable, queuing/simulation matters.

# ---- 4) Per-unit utilization (busy time / observation time) ----
util_by_unit <- ems %>%
  mutate(call_sec = as.numeric(DT.AVAILABLE - DT.DISP, units = "secs")) %>%
  group_by(VEH.GRID) %>%
  summarise(busy_sec = sum(call_sec, na.rm = TRUE), .groups = "drop") %>%
  mutate(utilization = busy_sec / obs_seconds) %>%
  arrange(desc(utilization))

util_by_unit

ggplot(util_by_unit, aes(reorder(VEH.GRID, utilization), utilization)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "Ambulance (VEH.GRID)", y = "Utilization",
       title = "Per-unit utilization over the observation window")

```

# Compare Near vs. Far North sites

```{r}
#| label: station-distances

# closest stations using UA (unadjusted) travel times
ems <- ems |>
  mutate(
    closest_current = if_else(eTT.UA.Ce <= eTT.UA.So, "Central", "South"),
    closest_current = factor(closest_current, levels = c("South","Central")),
    closer_north = case_when(
      !is.na(eTT.UA.NN) & !is.na(eTT.UA.FN) & eTT.UA.NN <= eTT.UA.FN ~ "Near North",
      !is.na(eTT.UA.NN) & !is.na(eTT.UA.FN) & eTT.UA.NN >  eTT.UA.FN ~ "Far North",
      TRUE ~ NA_character_
    ),
    closer_north = factor(closer_north, levels = c("Near North","Far North"))
  )

# nearest-base mismatch (current system)
mismatch_tbl <- ems |>
  mutate(match_base = BASE.NAME == closest_current) |>
  count(REF.GRID, match_base) |>
  group_by(REF.GRID) |>
  mutate(pct = n / sum(n)) |>
  ungroup()

mismatch_tbl
```

```{r}
#| label: near-vs-far-north

# how often Near vs Far is closer for North calls
north_choice <- ems |>
  filter(REF.GRID == "North") |>
  count(closer_north) |>
  mutate(pct = n / sum(n))

north_choice
```

```{r}
# nearest-base unavailable at dispatch (capacity Central=3, South=1)
cap_tbl <- tibble(base = c("Central","South"), cap = c(3L, 1L))

avail_check <- ems |>
  transmute(call_id = row_number(),
            t = DT.DISP,
            grid = REF.GRID,
            base = BASE.NAME,
            closest = closest_current)

busy_counts <- lapply(c("Central","South"), function(b) {
  idx <- which(ems$BASE.NAME == b & !is.na(ems$DT.DISP) & !is.na(ems$DT.AVAILABLE))
  starts <- ems$DT.DISP[idx]; ends <- ems$DT.AVAILABLE[idx]
  vapply(avail_check$t, function(tt) sum(starts <= tt & ends > tt), integer(1))
})
busy_df <- as.data.frame(busy_counts); names(busy_df) <- c("Central_busy","South_busy")
avail_check <- bind_cols(avail_check, busy_df)

avail_check <- avail_check |>
  left_join(cap_tbl, by = c("closest" = "base")) |>
  mutate(closest_busy = if_else(closest == "Central", Central_busy, South_busy),
         closest_available = closest_busy < cap)

unavail_by_region <- avail_check |>
  count(grid, closest_available) |>
  group_by(grid) |>
  mutate(pct = n / sum(n)) |>
  ungroup()

unavail_by_region
```

```{r}
# vizs

ggplot(ems, aes(REF.GRID, fill = closest_current)) +
  geom_bar(position = "fill") +
  labs(x = "", y = "Share", fill = "Closest (UA)", title = "Closest current base by region")

ems |>
  filter(REF.GRID == "North") |>
  tidyr::pivot_longer(c(eTT.UA.NN, eTT.UA.FN), names_to = "north_site", values_to = "ua_secs") |>
  mutate(north_site = recode(north_site, "eTT.UA.NN" = "Near North", "eTT.UA.FN" = "Far North"),
         ua_min = ua_secs/60) |>
  ggplot(aes(north_site, ua_min, fill = north_site)) +
  geom_boxplot(outlier.alpha = 0.1) +
  labs(x = "", y = "UA minutes", title = "North calls: UA time to Near vs Far")
```

# Other

```{r}
#| label: hospital-vs-no-hospital

# hospital vs no-hospital share and time distributions
hosp_share <- ems |>
  count(REF.GRID, went_hospital) |>
  group_by(REF.GRID) |>
  mutate(pct = n / sum(n)) |>
  ungroup()

hosp_share

ggplot(ems, aes(went_hospital, total_call_min)) +
  geom_boxplot() +
  labs(x = "Went to hospital?", y = "Total call minutes", title = "Total time by hospital vs no-hospital")

ggplot(ems, aes(REF.GRID, response_time_min, fill = REF.GRID)) +
  geom_boxplot(outlier.alpha = 0.1) +
  labs(x = "", y = "Response time (min)", title = "Observed response times by region") +
  theme(legend.position = "none")
```
Near vs Far North Station

```{r}
north_diffs <- ems %>%
  filter(REF.GRID == "North", !is.na(eTT.UA.NN), !is.na(eTT.UA.FN)) %>%
  mutate(diff_min = (eTT.UA.NN - eTT.UA.FN)/60)

north_diffs %>%
  summarise(mean_diff = mean(diff_min, na.rm=TRUE),
            median_diff = median(diff_min, na.rm=TRUE),
            pct_near_faster = mean(diff_min < 0, na.rm=TRUE))

ggplot(north_diffs, aes(diff_min)) +
  geom_histogram(bins = 40, fill="steelblue") +
  geom_vline(aes(xintercept = mean(diff_min, na.rm=TRUE)), linetype="dashed") +
  labs(x = "Near – Far (minutes)", y = "Calls",
       title = "North calls: time difference Near vs Far")

```

Move South truck vs. move a Central truck

View call share by region vs. number of units assigned to decide if South is “under-trucked.”

```{r}
ems %>%
  count(REF.GRID) %>%
  mutate(call_share = n/sum(n))

tibble(base = c("Central","South"),
       trucks = c(3,1),
       truck_share = trucks/sum(trucks))

```
Compare above side-by-side:
```{r}
# Call share by region
call_share <- ems %>%
  count(REF.GRID) %>%
  mutate(metric = "Calls",
         share = n / sum(n)) %>%
  select(name = REF.GRID, metric, share)

# Truck share by base
truck_share <- tibble(
  name   = c("Central","South"),
  trucks = c(3,1)
) %>%
  mutate(metric = "Trucks",
         share = trucks / sum(trucks)) %>%
  select(name, metric, share)

# Combine
compare_share <- bind_rows(call_share, truck_share)

# Plot: grouped bar chart
ggplot(compare_share, aes(x = name, y = share, fill = metric)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "Region/Base",
       y = "Share (%)",
       fill = "",
       title = "Comparison of % Calls vs % Trucks") +
  theme_minimal()

```



```{r}
north_value <- ems %>%
  mutate(best_current = pmin(eTT.UA.Ce, eTT.UA.So, na.rm=TRUE),
         best_with_north = pmin(eTT.UA.Ce, eTT.UA.So, eTT.UA.NN, eTT.UA.FN, na.rm=TRUE),
         saving_min = (best_current - best_with_north)/60)

north_value %>%
  summarise(mean_saving = mean(saving_min, na.rm=TRUE),
            median_saving = median(saving_min, na.rm=TRUE),
            pct_improved = mean(saving_min > 0, na.rm=TRUE))

```
Visualization of above:
```{r}
ggplot(north_value, aes(saving_min)) +
  geom_histogram(bins = 40, fill = "steelblue", color = "white", alpha = 0.8) +
  geom_vline(aes(xintercept = mean(saving_min, na.rm = TRUE)),
             linetype = "dashed", color = "red") +
  labs(
    x = "Minutes saved with North station (UA-based)",
    y = "Number of calls",
    title = "Distribution of response time savings with a North station"
  ) +
  theme_minimal()
```
```{r}
ggplot(north_value, aes(saving_min)) +
  geom_density(fill = "steelblue", alpha = 0.6) +
  geom_vline(aes(xintercept = mean(saving_min, na.rm = TRUE)),
             linetype = "dashed", color = "red") +
  labs(
    x = "Minutes saved with North station (UA-based)",
    y = "Density",
    title = "Distribution of response time savings with a North station"
  ) +
  theme_minimal()

```

