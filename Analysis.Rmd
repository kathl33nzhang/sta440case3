---
title: "Analysis"
output: html_document
---

```{r}
#| label: load-packages

library(tidyverse)
library(lubridate)
library(ggrepel)
library(knitr)
library(kableExtra)
```

```{r}
#| label: data-processing

load("emsData.RData")

ems <- x |>
  select(-c( # remove unneeded columns
    eTT.Pe.So, eTT.Pe.Ce, eTT.Pe.NN, eTT.Pe.FN,
    eTT.BG.So, eTT.BG.Ce, eTT.BG.NN, eTT.BG.FN,
    eTT.Op.So, eTT.Op.Ce, eTT.Op.NN, eTT.Op.FN
  )) |>
  mutate(
    BASE.NAME = recode(BASE.NAME,
                       "Company 9" = "Central",
                       "Company 1" = "South"),
    BASE.NAME = factor(BASE.NAME, levels = c("Central","South")),
    REF.GRID = case_when(
      str_detect(REF.GRID, "North")   ~ "North",
      str_detect(REF.GRID, "Central") ~ "Central",
      str_detect(REF.GRID, "South")   ~ "South",
      TRUE ~ REF.GRID
    ),
    REF.GRID = factor(REF.GRID, levels = c("South","Central","North")),
    DISPATCH.PRIORITY.NAME = recode(DISPATCH.PRIORITY.NAME,
                                    "Non Emergency" = "Non-emergency",
                                    "Emergency" = "Emergency"),
    DISPATCH.PRIORITY.NAME = factor(DISPATCH.PRIORITY.NAME,
                                    levels = c("Emergency","Non-emergency")),
    went_hospital = REC.NAME != ""
  ) |>
  mutate(
    disp_to_enroute_min = as.numeric(timeToEnroute, units = "mins"),
    response_time_min = as.numeric(observedTT,    units = "mins"),
    on_scene_min = as.numeric(onSceneDur,    units = "mins"),
    to_hospital_min = as.numeric(toHospitalTT,  units = "mins"),
    at_hospital_min = as.numeric(atHospitalDur, units = "mins"),
    total_call_min = as.numeric(dispToClearTime, units = "mins")
  )
```

```{r}
#| label: summary-stats

summaries <- list(
  response_by_region = ems |>
    group_by(REF.GRID) |>
    summarise(n = n(),
              median_resp = median(response_time_min, na.rm = TRUE),
              p90_resp    = quantile(response_time_min, 0.9, na.rm = TRUE)),
  north_near_far_share = north_choice,
  nearest_base_unavail = unavail_by_region,
  went_hospital_share  = hosp_share
)
summaries
```

# Call concentration 

```{r, fig.width=12, fig.height=6}

ems_plot <- data.frame(
  lon = as.numeric(x$REF.GPS.LON),
  lat = as.numeric(x$REF.GPS.LAT)
) |> na.omit() |>
  subset(lon > -78.55 & lon < -78.25 & lat > 36.15 & lat < 36.55)

stations <- data.frame(
  name = c("South","Central"),
  lat  = c(36.2765, 36.3450),
  lon  = c(-78.4004, -78.3905)
)

stations <- data.frame(
  name = c("South","Central"),
  lat  = c(36.2765, 36.3450),
  lon  = c(-78.4004, -78.3905)
)

ggplot(ems_plot, aes(lon, lat)) +
  # hex bins look nicer than squares
  geom_hex(bins = 35, alpha = 0.95) +
  coord_fixed() +
  scale_fill_viridis_c(trans = "sqrt", name = "Calls") +
  # stations: clearer markers + labels
  geom_point(data = stations, aes(lon, lat),
             inherit.aes = FALSE, shape = 21, size = 3.8,
             stroke = 1, colour = "black", fill = "white") +
  geom_label_repel(data = stations, aes(lon, lat, label = name),
                   inherit.aes = FALSE, size = 3,
                   label.padding = unit(0.12, "lines"),
                   label.size = 0, seed = 1) +
  labs(title = "EMS call density",
       subtitle = "Outlier removed",
       x = "Longitude", y = "Latitude") +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(face = "bold", size = 16),
    legend.key.height = unit(0.6, "cm")
  )
```

# Ambulance Utilization

```{r}
# --- 0) Clean datetimes & keep valid intervals ---
ems <- ems %>%
  mutate(
    DT.DISP      = as_datetime(DT.DISP),
    DT.AVAILABLE = as_datetime(DT.AVAILABLE)
  ) %>%
  filter(!is.na(VEH.GRID), !is.na(DT.DISP), !is.na(DT.AVAILABLE),
         DT.AVAILABLE >= DT.DISP)

# If two calls for the same ambulance overlap (due to logging quirks, delays, or bad timestamps), the code double-counts that unit as busy twice at the same time.
ems %>%
  arrange(VEH.GRID, DT.DISP) %>%
  group_by(VEH.GRID) %>%
  mutate(overlap = DT.DISP < lag(DT.AVAILABLE)) %>%
  filter(overlap == TRUE)

# Distinct vehicles present (sanity)
n_units <- n_distinct(ems$VEH.GRID)
if (n_units != 4) message("Note: dataset has ", n_units, " distinct VEH.GRID values.")

# Observation window (for utilization denominators)
t_start <- min(ems$DT.DISP, na.rm = TRUE)
t_end   <- max(ems$DT.AVAILABLE, na.rm = TRUE)
obs_seconds <- as.numeric(t_end - t_start, units = "secs")

# --- 1) Merge overlapping intervals within each vehicle ---
# Convert to numeric seconds for cummax, then back to POSIXct
ems_intervals <- ems %>%
  transmute(VEH.GRID,
            start_num = as.numeric(DT.DISP),
            end_num   = as.numeric(DT.AVAILABLE)) %>%
  arrange(VEH.GRID, start_num, end_num) %>%
  group_by(VEH.GRID) %>%
  mutate(
    prev_cummax_end = lag(cummax(end_num), default = first(start_num) - 1),
    new_block = start_num > prev_cummax_end,
    block_id  = cumsum(new_block)
  ) %>%
  group_by(VEH.GRID, block_id) %>%
  summarise(start_num = min(start_num),
            end_num   = max(end_num),
            .groups = "drop") %>%
  mutate(start = as_datetime(start_num),
         end   = as_datetime(end_num)) %>%
  select(VEH.GRID, start, end) %>%
  arrange(VEH.GRID, start, end)

```

```{r}

# --- 2) Build global event timeline (+1 at start, -1 at end) ---
events <- ems_intervals %>%
  pivot_longer(c(start, end), names_to = "etype", values_to = "time") %>%
  mutate(delta = if_else(etype == "start", 1L, -1L)) %>%
  arrange(time, desc(delta))   # process -1 before +1 at identical timestamps

timeline <- events %>%
  transmute(time, delta) %>%
  arrange(time) %>%
  mutate(active = cumsum(delta),
         time_next = lead(time),
         seg_sec   = as.numeric(time_next - time, "secs")) %>%
  filter(!is.na(time_next), seg_sec > 0)

# --- 3) Duration-weighted summary of simultaneous busy vehicles (capped at 4) ---
timeline <- timeline %>% mutate(active_capped = pmin(active, 4L))

simul_summary <- timeline %>%
  group_by(active = active_capped) %>%
  summarise(total_sec = sum(seg_sec), .groups = "drop") %>%
  mutate(pct_of_time = total_sec / sum(total_sec)) %>%
  arrange(active)

simul_summary
# active should now be 0..4 only

```

```{r}
library(knitr)
library(kableExtra)

simul_summary %>%
  mutate(
    `Active ambulances` = active,
    `Total time (hours)` = round(total_sec / 3600, 1),
    `% of time` = scales::percent(pct_of_time, accuracy = 0.1)
  ) %>%
  select(`Active ambulances`, `Total time (hours)`, `% of time`) %>%
  kable("html", align = "c", caption = "System Load: Simultaneous Busy Ambulances") %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover"))

# Plot
ggplot(simul_summary, aes(factor(active), pct_of_time)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "Simultaneous busy ambulances", y = "% of observed time",
       title = "System load: how many ambulances are busy simultaneously (capped at 4)")
```

```{r}

# --- 4) Percent of time fully saturated (all 4 busy) & other thresholds ---
pct_all_busy   <- simul_summary %>% filter(active >= 4) %>% summarise(p = sum(pct_of_time)) %>% pull(p)
pct_three_plus <- simul_summary %>% filter(active >= 3) %>% summarise(p = sum(pct_of_time)) %>% pull(p)

pct_all_busy
pct_three_plus

```

```{r}
# --- 5) Per-unit utilization (unchanged) ---
util_by_unit <- ems %>%
  mutate(call_sec = as.numeric(DT.AVAILABLE - DT.DISP, "secs")) %>%
  group_by(VEH.GRID) %>%
  summarise(busy_sec = sum(call_sec, na.rm = TRUE), .groups = "drop") %>%
  mutate(utilization = busy_sec / obs_seconds) %>%
  arrange(desc(utilization))

util_by_unit

# util_by_unit should already have: VEH.GRID, busy_sec, utilization
# If you also want color by base, grab a base label for each unit (mode per unit)
unit_base <- ems %>%
  count(VEH.GRID, BASE.NAME) %>%
  group_by(VEH.GRID) %>%
  slice_max(n, with_ties = FALSE) %>%
  ungroup() %>%
  select(VEH.GRID, BASE.NAME)

util_plot <- util_by_unit %>%
  left_join(unit_base, by = "VEH.GRID") %>%
  mutate(
    VEH.GRID = factor(VEH.GRID, levels = rev(VEH.GRID[order(utilization)])),
    label = scales::percent(utilization, accuracy = 0.1)
  )

# medic and company matching 
by_medic_base <- ems |>
  count(VEH.GRID, BASE.NAME, name = "n_calls") |>
  group_by(VEH.GRID) |>
  mutate(pct = n_calls / sum(n_calls)) |>
  arrange(VEH.GRID, desc(n_calls)) |>
  ungroup()

# quick look just for Company 1
by_medic_base |> filter(BASE.NAME == "Company 1")

primary_base <- by_medic_base |>
  group_by(VEH.GRID) |>
  slice_max(pct, with_ties = FALSE) |>
  ungroup() |>
  select(VEH.GRID, primary_base = BASE.NAME, share_at_primary = pct)

util_by_base <- ems |>
  mutate(call_sec = as.numeric(DT.AVAILABLE - DT.DISP, "secs")) |>
  group_by(BASE.NAME) |>
  summarise(busy_sec = sum(call_sec, na.rm = TRUE), .groups="drop") |>
  mutate(utilization = busy_sec / obs_seconds)

ggplot(by_medic_base, aes(x = reorder(VEH.GRID, -n_calls), y = pct, fill = BASE.NAME)) +
  geom_col(width = 0.7, color = "grey20") +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Medic (VEH.GRID)", y = "Share of calls by base",
       title = "Where each medic runs from (call share by base)") +
  coord_flip() + theme_minimal(base_size = 12) +
  theme(panel.grid.major.y = element_blank(), legend.position = "top")


```

```{r}
ggplot(util_plot, aes(x = VEH.GRID, y = utilization, fill = BASE.NAME)) +
  geom_col(width = 0.7, color = "grey20") +
  geom_text(aes(label = label), hjust = -0.1, size = 3.6, color = "grey10") +
  coord_flip(clip = "off") +
  scale_y_continuous(labels = scales::percent, expand = expansion(mult = c(0, 0.10))) +
  scale_fill_brewer(palette = "Set2", na.value = "grey70", name = "Base") +
  labs(
    title = "Per-unit utilization over the observation window",
    subtitle = "Percentage of time each ambulance was busy (dispatch â†’ available)",
    x = "Ambulance (VEH.GRID)",
    y = "Utilization"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title.y = element_text(margin = margin(r = 10)),
    axis.title.x = element_text(margin = margin(t = 6)),
    plot.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.margin = margin(10, 30, 10, 10) # room for labels on the right
  )
```

# Compare Near vs. Far North sites

```{r}
#| label: station-distances

# closest stations using UA (unadjusted) travel times
ems <- ems |>
  mutate(
    closest_current = if_else(eTT.UA.Ce <= eTT.UA.So, "Central", "South"),
    closest_current = factor(closest_current, levels = c("South","Central")),
    closer_north = case_when(
      !is.na(eTT.UA.NN) & !is.na(eTT.UA.FN) & eTT.UA.NN <= eTT.UA.FN ~ "Near North",
      !is.na(eTT.UA.NN) & !is.na(eTT.UA.FN) & eTT.UA.NN >  eTT.UA.FN ~ "Far North",
      TRUE ~ NA_character_
    ),
    closer_north = factor(closer_north, levels = c("Near North","Far North"))
  )

# nearest-base mismatch (current system)
mismatch_tbl <- ems |>
  mutate(match_base = BASE.NAME == closest_current) |>
  count(REF.GRID, match_base) |>
  group_by(REF.GRID) |>
  mutate(pct = n / sum(n)) |>
  ungroup()

mismatch_tbl
```

```{r}
#| label: near-vs-far-north

# how often Near vs Far is closer for North calls
north_choice <- ems |>
  filter(REF.GRID == "North") |>
  count(closer_north) |>
  mutate(pct = n / sum(n))

north_choice
```

```{r}
# nearest-base unavailable at dispatch (capacity Central=3, South=1)
cap_tbl <- tibble(base = c("Central","South"), cap = c(3L, 1L))

avail_check <- ems |>
  transmute(call_id = row_number(),
            t = DT.DISP,
            grid = REF.GRID,
            base = BASE.NAME,
            closest = closest_current)

busy_counts <- lapply(c("Central","South"), function(b) {
  idx <- which(ems$BASE.NAME == b & !is.na(ems$DT.DISP) & !is.na(ems$DT.AVAILABLE))
  starts <- ems$DT.DISP[idx]; ends <- ems$DT.AVAILABLE[idx]
  vapply(avail_check$t, function(tt) sum(starts <= tt & ends > tt), integer(1))
})
busy_df <- as.data.frame(busy_counts); names(busy_df) <- c("Central_busy","South_busy")
avail_check <- bind_cols(avail_check, busy_df)

avail_check <- avail_check |>
  left_join(cap_tbl, by = c("closest" = "base")) |>
  mutate(closest_busy = if_else(closest == "Central", Central_busy, South_busy),
         closest_available = closest_busy < cap)

unavail_by_region <- avail_check |>
  count(grid, closest_available) |>
  group_by(grid) |>
  mutate(pct = n / sum(n)) |>
  ungroup()

unavail_by_region
```

```{r}
# vizs

ggplot(ems, aes(REF.GRID, fill = closest_current)) +
  geom_bar(position = "fill") +
  labs(x = "", y = "Share", fill = "Closest (UA)", title = "Closest current base by region")

ems |>
  filter(REF.GRID == "North") |>
  tidyr::pivot_longer(c(eTT.UA.NN, eTT.UA.FN), names_to = "north_site", values_to = "ua_secs") |>
  mutate(north_site = recode(north_site, "eTT.UA.NN" = "Near North", "eTT.UA.FN" = "Far North"),
         ua_min = ua_secs/60) |>
  ggplot(aes(north_site, ua_min, fill = north_site)) +
  geom_boxplot(outlier.alpha = 0.1) +
  labs(x = "", y = "UA minutes", title = "North calls: UA time to Near vs Far")
```

# Other

```{r}
#| label: hospital-vs-no-hospital

# hospital vs no-hospital share and time distributions
hosp_share <- ems |>
  count(REF.GRID, went_hospital) |>
  group_by(REF.GRID) |>
  mutate(pct = n / sum(n)) |>
  ungroup()

hosp_share

ggplot(ems, aes(went_hospital, total_call_min)) +
  geom_boxplot() +
  labs(x = "Went to hospital?", y = "Total call minutes", title = "Total time by hospital vs no-hospital")

ggplot(ems, aes(REF.GRID, response_time_min, fill = REF.GRID)) +
  geom_boxplot(outlier.alpha = 0.1) +
  labs(x = "", y = "Response time (min)", title = "Observed response times by region") +
  theme(legend.position = "none")
```
